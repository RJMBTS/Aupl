name: Souloc Master
on:
  schedule:
    - cron: "30 18 * * *"   # ‚è∞ Runs every day at midnight IST (18:30 UTC)
  workflow_dispatch:

concurrency:
  group: souloc-m3u
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # ‚úÖ Normalize line endings safely
      - name: Normalize base.txt (convert CRLF ‚Üí LF)
        run: sed -i 's/\r$//' base.txt || true

      # ‚úÖ Backup existing playlist
      - name: Backup existing playlist
        run: |
          if [ -f "souloc.m3u" ]; then
            cp souloc.m3u souloc_backup.m3u
            echo "‚úÖ Backup created: souloc_backup.m3u"
          else
            echo "‚ÑπÔ∏è No previous souloc.m3u found, skipping backup."
          fi

      # ‚úÖ Merge all sources
      - name: Combine M3U files
        id: combine
        shell: bash
        run: |
          set -e
          TIME_IST=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S IST")
          TMP_FILE="souloc_temp.m3u"
          FINAL_FILE="souloc.m3u"
          > "$TMP_FILE"

          echo "üîó Merging playlists from $(wc -l < base.txt) sources..."
          cat base.txt

          COUNT=0
          while IFS= read -r url; do
            url="${url%%#*}"       # Remove inline comments
            url="$(echo -n "$url" | tr -d '\r')"  # Normalize
            if [ -n "$url" ]; then
              echo "Fetching: $url"
              curl -sL --max-time 30 --retry 3 --retry-delay 5 "$url" >> "$TMP_FILE" || echo "‚ö†Ô∏è Failed: $url"
              echo "" >> "$TMP_FILE"
              COUNT=$((COUNT+1))
            fi
          done < base.txt

          echo "‚úÖ Total source URLs processed: $COUNT"

          TOTAL_CHANNELS=$(grep -c '^#EXTINF' "$TMP_FILE" || true)
          echo "‚úÖ Channels found: $TOTAL_CHANNELS"

          # üö® Fail workflow if no channels were found
          if [ "$TOTAL_CHANNELS" -eq 0 ]; then
            echo "‚ùå ERROR: No channels found. Possible source failure or invalid URLs."
            exit 1
          fi

          # ‚úÖ Build final M3U
          {
            echo '# Pushed & Updated by Kittujk'
            echo '# Coded & Scripted for RJM Tv'
            echo "# Last updated: $TIME_IST"
            echo "# Channels : Total - $TOTAL_CHANNELS"
            echo ""
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo ""
          } > "$FINAL_FILE"

          cat "$TMP_FILE" >> "$FINAL_FILE"
          echo "# ---- Created Exclusively for RJM Souloc Playlist ----" >> "$FINAL_FILE"

          # ‚úÖ Export values for commit step
          echo "count=$TOTAL_CHANNELS" >> $GITHUB_OUTPUT
          echo "time=$TIME_IST" >> $GITHUB_OUTPUT

      # ‚úÖ Debug info
      - name: Verify output
        run: |
          echo "üßæ Generated files:"
          ls -lh *.m3u || true
          echo "üìÑ Preview of souloc.m3u:"
          head -n 20 souloc.m3u || true

      # ‚úÖ Commit only if file changed and not empty
      - name: Commit and push changes
        shell: bash
        env:
          GIT_AUTHOR_NAME: "GitHub Actions Bot"
          GIT_AUTHOR_EMAIL: "actions@github.com"
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"

          git pull --rebase origin main || true

          # Force track .m3u files (even if in .gitignore)
          git add -f souloc.m3u || true
          if [ -f "souloc_backup.m3u" ]; then
            git add -f souloc_backup.m3u || true
          fi

          echo "üßæ Files ready for commit:"
          git status --short

          if ! git diff --quiet --cached; then
            git commit -m "Auto-update Souloc Master Playlist [${{ steps.combine.outputs.time }}] | Channels: ${{ steps.combine.outputs.count }}"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
            echo "‚úÖ Changes pushed successfully."
          else
            echo "‚ÑπÔ∏è No new updates detected ‚Äî nothing to commit."
          fi
