name: Souloc Master ğŸŒ

on:
  schedule:
    - cron: "*/30 * * * *"   # â° Runs every 30 minutes
  workflow_dispatch:          # Manual trigger option

concurrency:
  group: souloc-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§© Build souloc.m3u (RJMBTS Edition)
        run: |
          set -euxo pipefail

          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)
          echo "ğŸ”¹ Starting Souloc M3U build at $timestamp"

          # ===== HEADER =====
          {
            echo "# ğŸ”¹ Souloc M3U â€” Powered by RJMBTS Network"
            echo "# ğŸ”¸ Coded & Maintained by @RJMBTS"
            echo "# ğŸ”¹ Auto-generated via GitHub Actions (Souloc Master)"
            echo "# ğŸ•’ Last updated: $timestamp"
            echo ""
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
          } > souloc.m3u
          # ===================

          # ===== SOURCE SETUP =====
          if [ ! -f base.txt ]; then
            echo "âš ï¸ base.txt not found â€” using default RJMBTS source."
            echo "https://raw.githubusercontent.com/mrr0b0t25/m3u/main/local.m3u" > base.txt
          fi

          echo "ğŸŒ Reading sources from base.txt..."
          grep -v '^#' base.txt | grep -v '^$' > "$tmpdir/sources.txt"

          if [ ! -s "$tmpdir/sources.txt" ]; then
            echo "âŒ No valid URLs in base.txt â€” stopping after header creation."
            exit 0
          fi

          echo "ğŸŒ Fetching M3U sources in parallel..."
          i=0
          while read -r url; do
            [[ -z "$url" ]] && continue
            i=$((i+1))
            {
              echo "ğŸ”¹ Fetching: $url"
              if curl -fsSL --max-time 60 "$url" | grep -v '^#EXTM3U' > "$tmpdir/part_$i.m3u"; then
                echo "âœ… Success: $url"
              else
                echo "âš ï¸ Failed: $url"
                echo "" > "$tmpdir/part_$i.m3u"
              fi
            } &
          done < "$tmpdir/sources.txt"
          wait

          echo "âœ… All sources fetched. Combining..."
          cat "$tmpdir"/part_*.m3u > "$tmpdir/all.m3u" || true

          echo "ğŸ§¹ Removing duplicates and numbering channels..."
          awk '
            BEGIN { ch=0 }
            /^#EXTINF/ {
              gsub(/[[:space:]]+/, " ", $0)
              info=$0
              getline url
              gsub(/[[:space:]]+/, "", url)
              if (url == "") next
              if (!(info in seen_info) && !(url in seen_url)) {
                seen_info[info]=1
                seen_url[url]=1
                ch++
                if (info !~ /tvg-chno=/) {
                  sub(/^#EXTINF:-1/, sprintf("#EXTINF:-1 tvg-chno=\"%d\"", ch), info)
                }
                print info
                print url
              }
            }
          ' "$tmpdir/all.m3u" >> souloc.m3u

          echo "ğŸ“Š Calculating build statistics..."
          total=$(grep -c '^#EXTINF' "$tmpdir/all.m3u" 2>/dev/null || echo 0)
          unique=$(grep -c '^#EXTINF' souloc.m3u 2>/dev/null || echo 0)

          current_list="$tmpdir/current_channels.txt"
          grep '^#EXTINF' souloc.m3u > "$current_list" || true

          if [ -f .souloc_previous.txt ]; then
            old_count=$(grep -c '^#EXTINF' .souloc_previous.txt 2>/dev/null || echo 0)
            new_added=$(grep -Fvx -f .souloc_previous.txt "$current_list" | grep -c '^#EXTINF' 2>/dev/null || echo 0)
          else
            old_count=0
            new_added=$unique
          fi

          if [ "$unique" -ge "$new_added" ]; then
            updated_count=$((unique - new_added))
          else
            updated_count=0
          fi

          cp "$current_list" .souloc_previous.txt

          echo "âœ… Souloc M3U successfully built under RJMBTS Network."
          echo "ğŸ“º Total channels fetched: $total"
          echo "ğŸ§¹ Unique channels after cleanup: $unique"
          echo "ğŸ†• Newly added channels: $new_added"
          echo "â™»ï¸ Updated channels: $updated_count"

          # ===== MARKDOWN SUMMARY =====
          {
            echo "## ğŸŒ Souloc Master â€” RJMBTS Auto-Build Summary"
            echo "| Metric | Count |"
            echo "|--------|--------:|"
            echo "| ğŸ“º Total fetched | ${total:-0} |"
            echo "| ğŸ§¹ Unique channels | ${unique:-0} |"
            echo "| ğŸ†• Newly added | ${new_added:-0} |"
            echo "| â™»ï¸ Updated | ${updated_count:-0} |"
            echo ""
            echo "ğŸ•’ **Last updated:** $timestamp"
            echo ""
            echo "ğŸ”¸ **Coded & Maintained by [@RJMBTS](https://github.com/RJMBTS)**"
            echo "ğŸ”¹ **Powered by RJM Tv & Souloc Network**"
          } >> $GITHUB_STEP_SUMMARY

      - name: ğŸš€ Commit & Push souloc.m3u (RJMBTS Auto)
        run: |
          set -euxo pipefail

          git config user.name "RJMBTS Auto Builder"
          git config user.email "actions@github.com"
          git add souloc.m3u .souloc_previous.txt || true

          if git diff --cached --quiet; then
            echo "No new changes â€” skipping commit."
          else
            git commit -m "ğŸ”„ Auto-update souloc.m3u (RJMBTS Network)"
            echo "ğŸ“¥ Rebasing latest main branch..."
            git pull --rebase origin main || git rebase --abort
            echo "ğŸš€ Pushing changes..."
            git push origin main || echo "âš ï¸ Push failed, but file built successfully."
          fi
