name: Souloc Master ğŸŒ

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"   # Runs every 30 minutes

concurrency:
  group: souloc-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§© Build souloc.m3u (Clean â€” No Headers, No Unknown)
        shell: bash
        env:
          TZ: "Asia/Kolkata"
        run: |
          set -euxo pipefail

          tmpdir=$(mktemp -d)
          cleanup() { rm -rf "$tmpdir"; }
          trap cleanup EXIT

          timestamp=$(date +"%Y-%m-%d %H:%M:%S %Z")
          out_file="souloc.m3u"

          echo "ğŸ”¹ Starting Souloc M3U build at $timestamp"

          # ===== SOURCE CHECK =====
          if [ ! -s base.txt ]; then
            echo "âŒ base.txt missing or empty â€” cannot proceed."
            exit 1
          fi

          grep -v '^\s*#' base.txt | sed '/^[[:space:]]*$/d' > "$tmpdir/sources.txt"

          if [ ! -s "$tmpdir/sources.txt" ]; then
            echo "âŒ No valid URLs in base.txt â€” aborting."
            exit 1
          fi

          echo "ğŸŒ Using sources from base.txt:"
          cat "$tmpdir/sources.txt"

          # ===== FETCH SOURCES =====
          i=0
          while IFS= read -r url || [ -n "$url" ]; do
            [ -z "$url" ] && continue
            i=$((i+1))
            {
              echo "ğŸ”¹ Fetching: $url"
              if curl -fsSL --max-time 60 --retry 2 "$url" | grep -v '^#EXTM3U' > "$tmpdir/part_$i.m3u"; then
                echo "âœ… Success: $url"
              else
                echo "âš ï¸ Failed: $url"
                : > "$tmpdir/part_$i.m3u"
              fi
            } &
            ((i%8==0)) && wait
          done < "$tmpdir/sources.txt"
          wait

          cat "$tmpdir"/part_*.m3u > "$tmpdir/all.m3u" || true

          echo "ğŸ§¹ Removing duplicates..."
          awk '
            BEGIN { ch=0 }
            /^#EXTINF/ {
              info=$0; gsub(/[[:space:]]+/, " ", info)
              getline url; gsub(/[[:space:]]+/, "", url)
              if (url=="") next
              key = info "|" url
              if (!(key in seen)) {
                seen[key]=1
                print info; print url
              }
            }
          ' "$tmpdir/all.m3u" > "$tmpdir/all_unique.m3u"

          total=$(grep -c '^#EXTINF' "$tmpdir/all.m3u" || echo 0)
          updated=$(grep -c '^#EXTINF' "$tmpdir/all_unique.m3u" || echo 0)

          echo "ğŸ“Š Splitting by language..."
          mkdir -p "$tmpdir/langs"

          awk -v tmpdir="$tmpdir/langs" '
            /^#EXTINF/ {
              info=$0
              lang=""
              if (match(info, /group-title="([^"]+)"/, a)) lang=a[1]
              getline url
              gsub(/^[ \t\r\n]+|[ \t\r\n]+$/, "", url)
              if (url=="") next
              if (lang == "" || lang == "Unknown") next  # skip unknowns
              file = tmpdir "/" lang ".m3u"
              print info > file
              print url  > file
            }
          ' "$tmpdir/all_unique.m3u"

          echo "Language,Channels" > "$tmpdir/lang_stats.csv"
          for f in "$tmpdir/langs"/*.m3u; do
            lang=$(basename "$f" .m3u)
            count=$(grep -c '^#EXTINF' "$f" || echo 0)
            echo "$lang,$count" >> "$tmpdir/lang_stats.csv"
          done

          # ===== HEADER =====
          {
            echo "# ğŸ”¹ Pushed and Updated by Kittujk"
            echo "# ğŸ”¸ Coded & Maintained by @RJMBTS"
            echo "# ğŸ•’ Last updated: $timestamp"
            echo "# ğŸ“º Channels : Total - $total | Updated - $updated"
            echo ""
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo ""
          } > "$out_file"

          echo "ğŸ”  Sorting Aâ€“Z and merging..."
          tail -n +2 "$tmpdir/lang_stats.csv" | sort -t, -k2 -nr | while IFS=, read -r lang num; do
            file="$tmpdir/langs/$lang.m3u"
            [ ! -f "$file" ] && continue

            # Just merge sorted channel list â€” no headers
            awk '
              /^#EXTINF/ {info=$0; getline url; data[info]=url}
              END {
                n=asorti(data, sorted)
                ch=1
                for (i=1; i<=n; i++) {
                  info=sorted[i]; url=data[info]
                  if (info !~ /tvg-chno=/)
                    sub(/^#EXTINF:-1/, sprintf("#EXTINF:-1 tvg-chno=\"%d\"", ch), info)
                  print info; print url; ch++
                }
              }
            ' "$file" >> "$out_file"
          done

          echo "âœ… Souloc M3U built successfully â€” clean output!"
          echo "ğŸ“º Total: $total | â™»ï¸ Unique: $updated"

          # ===== Minimal GitHub Summary =====
          {
            echo "## ğŸŒ Souloc Master â€” RJMBTS Auto-Build Summary"
            echo "| Metric | Count |"
            echo "|--------|--------:|"
            echo "| ğŸ“º Total fetched | ${total:-0} |"
            echo "| â™»ï¸ Unique (updated) | ${updated:-0} |"
            echo ""
            echo "ğŸ•’ **Last updated:** $timestamp"
            echo ""
            echo "ğŸ”¸ **Coded & Maintained by [@RJMBTS](https://github.com/RJMBTS)**"
            echo "ğŸ”¹ **Powered by RJM Tv & Souloc Network**"
          } >> $GITHUB_STEP_SUMMARY

      - name: ğŸš€ Commit & Push souloc.m3u (RJMBTS Auto)
        shell: bash
        run: |
          set -euxo pipefail
          git config user.name "RJMBTS Auto Builder"
          git config user.email "actions@github.com"
          git add souloc.m3u || true

          if git diff --cached --quiet; then
            echo "No new changes â€” skipping commit."
          else
            git commit -m "ğŸ”„ Auto-update souloc.m3u (RJMBTS Network)"
            git pull --rebase origin main || git rebase --abort
            git push origin main || echo "âš ï¸ Push failed but build succeeded."
          fi
