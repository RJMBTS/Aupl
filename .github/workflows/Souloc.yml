name: Souloc Master üåê

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"   # ‚è∞ Runs every 30 minutes

concurrency:
  group: souloc-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üß© Build souloc.m3u (Final Pro ‚Äî Flags, Sorted A‚ÄìZ, Header Counts)
        shell: bash
        env:
          TZ: "Asia/Kolkata"
        run: |
          set -euxo pipefail

          tmpdir=$(mktemp -d)
          cleanup() { rm -rf "$tmpdir"; }
          trap cleanup EXIT

          timestamp=$(date +"%Y-%m-%d %H:%M:%S %Z")
          out_file="souloc.m3u"

          echo "üîπ Starting Souloc M3U build at $timestamp"

          # ===== SOURCE SETUP =====
          if [ ! -f base.txt ]; then
            echo "‚ö†Ô∏è base.txt not found ‚Äî using default RJMBTS source."
            echo "https://raw.githubusercontent.com/mrr0b0t25/m3u/main/local.m3u" > base.txt
          fi

          grep -v '^\s*#' base.txt | sed '/^[[:space:]]*$/d' > "$tmpdir/sources.txt" || true
          [ ! -s "$tmpdir/sources.txt" ] && { echo "‚ùå No valid URLs ‚Äî exiting."; exit 0; }

          echo "üåê Fetching M3U sources..."
          i=0
          while IFS= read -r url || [ -n "$url" ]; do
            [ -z "$url" ] && continue
            i=$((i+1))
            {
              echo "üîπ Fetching: $url"
              if curl -fsSL --max-time 60 --retry 2 "$url" | grep -v '^#EXTM3U' > "$tmpdir/part_$i.m3u"; then
                echo "‚úÖ Success: $url"
              else
                echo "‚ö†Ô∏è Failed: $url"
                : > "$tmpdir/part_$i.m3u"
              fi
            } &
            ((i%8==0)) && wait
          done < "$tmpdir/sources.txt"
          wait

          cat "$tmpdir"/part_*.m3u > "$tmpdir/all.m3u" || true

          echo "üßπ Removing duplicates..."
          awk '
            BEGIN { ch=0 }
            /^#EXTINF/ {
              info=$0; gsub(/[[:space:]]+/, " ", info)
              getline url; gsub(/[[:space:]]+/, "", url)
              if (url=="") next
              key = info "|" url
              if (!(key in seen)) {
                seen[key]=1
                print info; print url
              }
            }
          ' "$tmpdir/all.m3u" > "$tmpdir/all_unique.m3u"

          total=$(grep -c '^#EXTINF' "$tmpdir/all.m3u" || echo 0)
          updated=$(grep -c '^#EXTINF' "$tmpdir/all_unique.m3u" || echo 0)

          echo "üìä Splitting by language..."
          mkdir -p "$tmpdir/langs"

          awk -v tmpdir="$tmpdir/langs" '
            /^#EXTINF/ {
              info=$0
              lang="Unknown"
              if (match(info, /group-title="([^"]+)"/, a)) lang=a[1]
              getline url
              gsub(/^[ \t\r\n]+|[ \t\r\n]+$/, "", url)
              if (url=="") next
              file = tmpdir "/" lang ".m3u"
              print info > file
              print url  > file
            }
          ' "$tmpdir/all_unique.m3u"

          # Flags for sections
          declare -A flags=(
            ["Telugu"]="üáÆüá≥"
            ["Hindi"]="üáÆüá≥"
            ["Tamil"]="üáÆüá≥"
            ["Malayalam"]="üáÆüá≥"
            ["Kannada"]="üáÆüá≥"
            ["English"]="üá¨üáß"
            ["Sports"]="üèÜ"
            ["Kids"]="üßí"
            ["Music"]="üéµ"
            ["Movies"]="üé¨"
            ["News"]="üóûÔ∏è"
            ["Unknown"]="‚ùì"
          )

          echo "Language,Channels" > "$tmpdir/lang_stats.csv"
          for f in "$tmpdir/langs"/*.m3u; do
            lang=$(basename "$f" .m3u)
            count=$(grep -c '^#EXTINF' "$f" || echo 0)
            echo "$lang,$count" >> "$tmpdir/lang_stats.csv"
          done

          # ===== HEADER WITH TOTALS =====
          {
            echo "# üîπ Pushed and Updated by Kittujk"
            echo "# üî∏ Coded & Maintained by @RJMBTS"
            echo "# üïí Last updated: $timestamp"
            echo "# üì∫ Total Channels: $total"
            echo "# ‚ôªÔ∏è Unique Channels: $updated"
            echo ""
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo ""
          } > "$out_file"

          # ===== LANGUAGE SUMMARY =====
          {
            echo "# ===== LANGUAGE SUMMARY ====="
            tail -n +2 "$tmpdir/lang_stats.csv" | sort -t, -k2 -nr | while IFS=, read -r lang num; do
              flag="${flags[$lang]:-üåê}"
              echo "# $flag $lang: $num channels"
            done
            echo ""
            echo "# ===== SORTED CHANNELS BY LANGUAGE ====="
            echo ""
          } >> "$out_file"

          echo "üî† Sorting A‚ÄìZ inside each language..."
          tail -n +2 "$tmpdir/lang_stats.csv" | sort -t, -k2 -nr | while IFS=, read -r lang num; do
            file="$tmpdir/langs/$lang.m3u"
            [ ! -f "$file" ] && continue
            flag="${flags[$lang]:-üåê}"

            echo "" >> "$out_file"
            echo "# ---------------------------" >> "$out_file"
            echo "# ‚ñ∂Ô∏è $flag $lang Channels (A‚ÄìZ)" >> "$out_file"
            echo "# ---------------------------" >> "$out_file"

            awk '
              /^#EXTINF/ {info=$0; getline url; data[info]=url}
              END {
                n=asorti(data, sorted)
                ch=1
                for (i=1; i<=n; i++) {
                  info=sorted[i]; url=data[info]
                  if (info !~ /tvg-chno=/)
                    sub(/^#EXTINF:-1/, sprintf("#EXTINF:-1 tvg-chno=\"%d\"", ch), info)
                  print info; print url; ch++
                }
              }
            ' "$file" >> "$out_file"

            echo "" >> "$out_file"
          done

          echo "‚úÖ Souloc M3U built successfully!"
          echo "üì∫ Total: $total | ‚ôªÔ∏è Unique: $updated"

          # ===== GitHub Summary =====
          {
            echo "## üåê Souloc Master ‚Äî RJMBTS Auto-Build Summary"
            echo "| Metric | Count |"
            echo "|--------|--------:|"
            echo "| üì∫ Total fetched | ${total:-0} |"
            echo "| ‚ôªÔ∏è Unique (updated) | ${updated:-0} |"
            echo ""
            echo "### üìä Channels by Language"
            echo "| Language | Channels |"
            echo "|-----------|-----------:|"
            tail -n +2 "$tmpdir/lang_stats.csv" | sort -t, -k2 -nr | awk -F, '{printf "| %s | %s |\n", $1, $2}'
            echo ""
            echo "üïí **Last updated:** $timestamp"
            echo ""
            echo "üî∏ **Coded & Maintained by [@RJMBTS](https://github.com/RJMBTS)**"
            echo "üîπ **Powered by RJM Tv & Souloc Network**"
          } >> $GITHUB_STEP_SUMMARY

      - name: üöÄ Commit & Push souloc.m3u (RJMBTS Auto)
        shell: bash
        run: |
          set -euxo pipefail
          git config user.name "RJMBTS Auto Builder"
          git config user.email "actions@github.com"
          git add souloc.m3u || true

          if git diff --cached --quiet; then
            echo "No new changes ‚Äî skipping commit."
          else
            git commit -m "üîÑ Auto-update souloc.m3u (RJMBTS Network)"
            git pull --rebase origin main || git rebase --abort
            git push origin main || echo "‚ö†Ô∏è Push failed but build succeeded."
          fi
