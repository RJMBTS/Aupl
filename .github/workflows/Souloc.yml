name: Souloc Master
on:
  schedule:
    - cron: "30 18 * * *"   # â° Runs daily at midnight IST (18:30 UTC)
  workflow_dispatch:

concurrency:
  group: souloc-m3u
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # âœ… Normalize Windows line endings safely
      - name: Normalize base.txt (convert CRLF â†’ LF)
        run: sed -i 's/\r$//' base.txt || true

      # âœ… Merge, deduplicate, and build playlist
      - name: Combine M3U files
        id: combine
        shell: bash
        run: |
          set -e
          TIME_IST=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S IST")
          TMP_FILE="souloc_temp.m3u"
          FINAL_FILE="souloc.m3u"
          OLD_FILE="souloc_old.m3u"

          # Keep old playlist only for comparison
          if [ -f "$FINAL_FILE" ]; then
            cp "$FINAL_FILE" "$OLD_FILE"
          fi

          > "$TMP_FILE"
          echo "ğŸ”— Merging playlists from $(wc -l < base.txt) sources..."
          cat base.txt

          COUNT=0
          while IFS= read -r url; do
            url="${url%%#*}"
            url="$(echo -n "$url" | tr -d '\r')"
            if [ -n "$url" ]; then
              echo "Fetching: $url"
              curl -sL --max-time 30 --retry 3 --retry-delay 5 "$url" >> "$TMP_FILE" || echo "âš ï¸ Failed: $url"
              echo "" >> "$TMP_FILE"
              COUNT=$((COUNT+1))
            fi
          done < base.txt

          echo "âœ… Total source URLs processed: $COUNT"

          TOTAL_CHANNELS=$(grep -c '^#EXTINF' "$TMP_FILE" || true)
          echo "âœ… Channels found before deduplication: $TOTAL_CHANNELS"

          # ğŸš¨ Fail if no channels found
          if [ "$TOTAL_CHANNELS" -eq 0 ]; then
            echo "âŒ ERROR: No channels found. Sources may be offline."
            exit 1
          fi

          # âœ… Deduplicate by channel name + URL
          echo "ğŸ”„ Removing duplicate channels (by name and URL)..."
          awk -v RS="" '
            {
              name=""; url="";
              for (i = 1; i <= NF; i++) {
                if ($i ~ /^#EXTINF/) {
                  match($i, /,(.*)$/, arr)
                  name = arr[1]
                } else if ($i ~ /^http/) {
                  url = $i
                }
              }
              key = name "|" url
              if (!(key in seen)) {
                seen[key] = 1
                print $0 "\n"
              }
            }
          ' "$TMP_FILE" > "souloc_deduped.m3u"

          DEDUPED_COUNT=$(grep -c '^#EXTINF' souloc_deduped.m3u || true)
          echo "âœ… Channels after deduplication: $DEDUPED_COUNT"
          mv souloc_deduped.m3u "$TMP_FILE"

          # âœ… Compute Updated, New, and Removed Channels
          UPDATED_CHANNELS=0
          NEW_CHANNELS=0
          REMOVED_CHANNELS=0

          if [ -f "$OLD_FILE" ]; then
            echo "ğŸ” Comparing with previous playlist..."

            # Extract pairs: name | url
            awk '/^#EXTINF/{name=$0; getline url; print name "|" url}' "$TMP_FILE" | sort > new_pairs.txt
            awk '/^#EXTINF/{name=$0; getline url; print name "|" url}' "$OLD_FILE" | sort > old_pairs.txt

            # Extract only names
            awk -F'|' '{sub(/^.*,/,"",$1); print $1}' new_pairs.txt | sort > new_names.txt
            awk -F'|' '{sub(/^.*,/,"",$1); print $1}' old_pairs.txt | sort > old_names.txt

            # Detect newly added names
            NEW_CHANNELS=$(comm -23 new_names.txt old_names.txt | wc -l || true)

            # Detect removed names
            REMOVED_CHANNELS=$(comm -13 new_names.txt old_names.txt | wc -l || true)

            # Detect updated (same name, different URL)
            UPDATED_CHANNELS=$(comm -12 new_names.txt old_names.txt | while read -r name; do
              new_url=$(grep "$name" new_pairs.txt | awk -F'|' '{print $2}' | head -1)
              old_url=$(grep "$name" old_pairs.txt | awk -F'|' '{print $2}' | head -1)
              [ "$new_url" != "$old_url" ] && echo "$name"
            done | wc -l || true)
          else
            echo "â„¹ï¸ No previous playlist found â€” treating all as new."
            NEW_CHANNELS=$DEDUPED_COUNT
          fi

          echo "ğŸ†• Newly Added Channels: $NEW_CHANNELS"
          echo "ğŸ” Updated Channels: $UPDATED_CHANNELS"
          echo "ğŸ—‘ï¸ Removed Channels: $REMOVED_CHANNELS"

          # âœ… Build final playlist with full analytics header
          {
            echo '# Pushed & Updated by Kittujk'
            echo '# Coded & Scripted for RJM Tv'
            echo "# Last updated: $TIME_IST"
            echo "# Channels : Total - $DEDUPED_COUNT | Updated - $UPDATED_CHANNELS | Newly Added - $NEW_CHANNELS | Removed - $REMOVED_CHANNELS"
            echo ""
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo ""
          } > "$FINAL_FILE"

          cat "$TMP_FILE" >> "$FINAL_FILE"
          echo "# ---- Created Exclusively for RJM Souloc Playlist ----" >> "$FINAL_FILE"

          echo "count=$DEDUPED_COUNT" >> $GITHUB_OUTPUT
          echo "updated=$UPDATED_CHANNELS" >> $GITHUB_OUTPUT
          echo "new=$NEW_CHANNELS" >> $GITHUB_OUTPUT
          echo "removed=$REMOVED_CHANNELS" >> $GITHUB_OUTPUT
          echo "time=$TIME_IST" >> $GITHUB_OUTPUT


      # ğŸŸ© âœ… NEW STEP: Log results to souloc_stats.txt (history)
      - name: Log playlist statistics
        if: ${{ always() }}
        run: |
          echo "[${{ steps.combine.outputs.time }}] Total: ${{ steps.combine.outputs.count }} | Updated: ${{ steps.combine.outputs.updated }} | New: ${{ steps.combine.outputs.new }} | Removed: ${{ steps.combine.outputs.removed }}" >> souloc_stats.txt
          git add -f souloc_stats.txt || true
          echo "ğŸ§¾ Logged playlist statistics to souloc_stats.txt"


      # âœ… Verify output
      - name: Verify output
        run: |
          echo "ğŸ§¾ Generated files:"
          ls -lh souloc.m3u || true
          echo "ğŸ“„ Preview of souloc.m3u:"
          head -n 25 souloc.m3u || true

      # âœ… Commit only if any changes (new, updated, or removed)
      - name: Commit and push changes
        if: ${{ or(steps.combine.outputs.updated != '0', steps.combine.outputs.new != '0', steps.combine.outputs.removed != '0') }}
        shell: bash
        env:
          GIT_AUTHOR_NAME: "GitHub Actions Bot"
          GIT_AUTHOR_EMAIL: "actions@github.com"
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"

          git pull --rebase origin main || true
          git add -f souloc.m3u || true
          git add -f souloc_stats.txt || true

          echo "ğŸ§¾ Files ready for commit:"
          git status --short

          if ! git diff --quiet --cached; then
            git commit -m "Auto-update Souloc Master Playlist [${{ steps.combine.outputs.time }}] | Total: ${{ steps.combine.outputs.count }} | Updated: ${{ steps.combine.outputs.updated }} | Newly Added: ${{ steps.combine.outputs.new }} | Removed: ${{ steps.combine.outputs.removed }}"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
            echo "âœ… Playlist and stats log updated successfully."
          else
            echo "â„¹ï¸ No new updates detected â€” nothing to commit."
          fi

      # ğŸŸ¡ Skip if no differences
      - name: No changes detected
        if: ${{ and(steps.combine.outputs.updated == '0', steps.combine.outputs.new == '0', steps.combine.outputs.removed == '0') }}
        run: echo "â„¹ï¸ No new, updated, or removed channels detected â€” skipping commit."
