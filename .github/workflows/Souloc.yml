name: Souloc Master

on:
  schedule:
    - cron: "*/30 * * * *"   # ‚è∞ Runs every 30 minutes
  workflow_dispatch:          # Manual trigger option

concurrency:
  group: souloc-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build souloc.m3u from base.txt
        run: |
          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)

          echo "üîπ Starting Souloc M3U build at $timestamp"

          # ===== HEADER =====
          {
            echo "# Pushed and Updated by Kittujk"
            echo "# Coded & Maintained @RJMBTS"
            echo "# Last updated: $timestamp"
            echo ""
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo ""
          } > souloc.m3u
          # ===================

          if [ ! -f base.txt ]; then
            echo "‚ùå base.txt not found ‚Äî exiting."
            exit 1
          fi

          echo "üåê Reading sources from base.txt..."
          grep -v '^#' base.txt | grep -v '^$' > "$tmpdir/sources.txt"

          if [ ! -s "$tmpdir/sources.txt" ]; then
            echo "‚ùå No valid URLs in base.txt ‚Äî exiting."
            exit 0
          fi

          echo "üåê Fetching M3U sources in parallel..."
          i=0
          while read -r url; do
            [[ -z "$url" ]] && continue
            i=$((i+1))
            {
              echo "üîπ Fetching: $url"
              if curl -fs --max-time 20 "$url" | grep -v -E '^#EXTM3U' > "$tmpdir/part_$i.m3u"; then
                echo "‚úÖ Success: $url"
              else
                echo "‚ö†Ô∏è Failed: $url"
                echo "" > "$tmpdir/part_$i.m3u"
              fi
            } &
          done < "$tmpdir/sources.txt"

          wait
          echo "‚úÖ All sources fetched. Combining..."

          cat "$tmpdir"/part_*.m3u >> "$tmpdir/all.m3u"

          echo "üßπ Removing duplicates (based on #EXTINF OR URL)..."
          awk '
            /^#EXTINF/ {
              info=$0
              getline url
              # Skip empty URLs
              if (url == "") next
              # Remove if either info or url was already seen
              if (!(info in seen_info) && !(url in seen_url)) {
                seen_info[info]=1
                seen_url[url]=1
                print info
                print url
              }
            }
          ' "$tmpdir/all.m3u" >> souloc.m3u

          total=$(grep -c '^#EXTINF' "$tmpdir/all.m3u" || true)
          unique=$(grep -c '^#EXTINF' souloc.m3u || true)

          echo "‚úÖ souloc.m3u built successfully."
          echo "üìä Total channels fetched: $total"
          echo "üìä Unique channels after cleanup: $unique"

          echo "### Souloc.m3u Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Total channels fetched: $total" >> $GITHUB_STEP_SUMMARY
          echo "- Unique channels after cleanup: $unique" >> $GITHUB_STEP_SUMMARY
          echo "- Last updated: $(date)" >> $GITHUB_STEP_SUMMARY

      - name: Commit and push souloc.m3u (safe auto-merge)
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add souloc.m3u

          if ! git diff --cached --quiet; then
            git commit -m "Auto-update souloc.m3u"

            echo "üì• Pulling latest changes (with auto-merge)..."
            git fetch origin main
            git reset --soft HEAD~1  # keep commit staged if rebase fails
            git stash push --include-untracked
            git pull origin main --strategy-option ours || true
            git stash pop || true

            echo "üöÄ Pushing updated version..."
            n=0
            until [ "$n" -ge 3 ]
            do
              git push origin main && break
              n=$((n+1))
              echo "‚ö†Ô∏è Push failed, retrying in 10s... ($n/3)"
              sleep 10
            done
          else
            echo "No new changes ‚Äî skipping commit."
          fi
