name: Master M3U Playlists

on:
  schedule:
    - cron: '*/15 * * * *'  # Runs every 15 minutes
  workflow_dispatch:          # Manual trigger option

concurrency:
  group: master-m3u
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Combine M3U files into Master.m3u
        run: |
          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")

          {
            echo "#EXTM3U"
            echo "# Pushed and updated by Kittujk"
            echo "# Last updated: $timestamp"
          } > Master.m3u

          while read -r url; do
            [[ -z "$url" ]] && continue
            echo "" >> Master.m3u
            if curl -fs "$url" | grep -v -E '^#EXTM3U' >> Master.m3u; then
              echo "✅ Added: $url"
            else
              echo "⚠️ Failed: $url"
            fi
          done < Sources.txt

      - name: Generate onetv.m3u (for Vercel)
        run: |
          cp Master.m3u onetv.m3u
          echo "onetv.m3u synced successfully with Master.m3u"

      - name: Commit and push updated playlists
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add Master.m3u onetv.m3u
          if ! git diff --cached --quiet; then
            git commit -m "Auto-update Master.m3u and onetv.m3u"
            git push origin main
          else
            echo "No changes detected — skipping commit."
          fi
