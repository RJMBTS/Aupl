      - name: ðŸ§© Souloc Master Builder
        shell: bash
        env:
          TZ: "Asia/Kolkata"
        run: |
          set -euxo pipefail

          tmpdir=$(mktemp -d)
          cleanup() { rm -rf "$tmpdir"; }
          trap cleanup EXIT

          timestamp=$(date +"%Y-%m-%d %H:%M:%S %Z")
          out_file="souloc.m3u"
          echo "ðŸ”¹ Starting Souloc M3U build at $timestamp"

          # ===== HEADER =====
          {
            echo "# ðŸ”¹ Pushed and Updated by Kittujk"
            echo "# ðŸ”¸ Coded & Maintained by @RJMBTS"
            echo "# ðŸ•’ Last updated: $timestamp"
            echo ""
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo ""
          } > "$out_file"

          # ===== SOURCE SETUP =====
          if [ ! -f base.txt ]; then
            echo "âš ï¸ base.txt not found â€” using default RJMBTS source."
            echo "https://raw.githubusercontent.com/mrr0b0t25/m3u/main/local.m3u" > base.txt
          fi

          grep -v '^\s*#' base.txt | sed '/^[[:space:]]*$/d' > "$tmpdir/sources.txt" || true
          [ ! -s "$tmpdir/sources.txt" ] && { echo "âŒ No valid URLs â€” exiting."; exit 0; }

          echo "ðŸŒ Fetching M3U sources in parallel..."
          i=0
          while IFS= read -r url || [ -n "$url" ]; do
            [ -z "$url" ] && continue
            i=$((i+1))
            {
              echo "ðŸ”¹ Fetching: $url"
              if curl -fsSL --max-time 60 --retry 2 "$url" | grep -v '^#EXTM3U' > "$tmpdir/part_$i.m3u"; then
                echo "âœ… Success: $url"
              else
                echo "âš ï¸ Failed: $url"
                : > "$tmpdir/part_$i.m3u"
              fi
            } &
            ((i%8==0)) && wait
          done < "$tmpdir/sources.txt"
          wait

          cat "$tmpdir"/part_*.m3u > "$tmpdir/all.m3u" || true

          echo "ðŸ§¹ Removing duplicates..."
          awk '
            BEGIN { ch=0 }
            /^#EXTINF/ {
              info=$0; gsub(/[[:space:]]+/, " ", info)
              getline url; gsub(/[[:space:]]+/, "", url)
              if (url=="") next
              key = info "|" url
              if (!(key in seen)) {
                seen[key]=1
                print info; print url
              }
            }
          ' "$tmpdir/all.m3u" > "$tmpdir/all_unique.m3u"

          total=$(grep -c '^#EXTINF' "$tmpdir/all.m3u" || echo 0)
          updated=$(grep -c '^#EXTINF' "$tmpdir/all_unique.m3u" || echo 0)

          echo "ðŸ“Š Splitting and numbering per language..."
          mkdir -p "$tmpdir/langs"

          awk -v tmpdir="$tmpdir/langs" '
            /^#EXTINF/ {
              info=$0
              lang="Unknown"
              if (match(info, /group-title="([^"]+)"/, a)) lang=a[1]
              getline url
              gsub(/^[ \t\r\n]+|[ \t\r\n]+$/, "", url)
              if (url=="") next
              file = tmpdir "/" lang ".m3u"
              print info > file
              print url  > file
            }
          ' "$tmpdir/all_unique.m3u"

          # Flag emojis for common languages
          declare -A flags=(
            ["Telugu"]="ðŸ‡®ðŸ‡³"
            ["Hindi"]="ðŸ‡®ðŸ‡³"
            ["Tamil"]="ðŸ‡®ðŸ‡³"
            ["Malayalam"]="ðŸ‡®ðŸ‡³"
            ["Kannada"]="ðŸ‡®ðŸ‡³"
            ["English"]="ðŸ‡¬ðŸ‡§"
            ["Sports"]="ðŸ†"
            ["Kids"]="ðŸ§’"
            ["Music"]="ðŸŽµ"
            ["Movies"]="ðŸŽ¬"
            ["News"]="ðŸ—žï¸"
            ["Unknown"]="â“"
          )

          echo "Language,Channels" > "$tmpdir/lang_stats.csv"
          for f in "$tmpdir/langs"/*.m3u; do
            lang=$(basename "$f" .m3u)
            count=$(grep -c '^#EXTINF' "$f" || echo 0)
            echo "$lang,$count" >> "$tmpdir/lang_stats.csv"
          done

          # Append language summary
          {
            echo ""
            echo "# ===== LANGUAGE SUMMARY ====="
            tail -n +2 "$tmpdir/lang_stats.csv" | sort -t, -k2 -nr | while IFS=, read -r lang num; do
              flag="${flags[$lang]:-ðŸŒ}"
              echo "# $flag $lang: $num channels"
            done
            echo ""
            echo "# ===== SORTED CHANNELS BY LANGUAGE ====="
            echo ""
          } >> "$out_file"

          # Sort and renumber per language
          tail -n +2 "$tmpdir/lang_stats.csv" | sort -t, -k2 -nr | while IFS=, read -r lang num; do
            file="$tmpdir/langs/$lang.m3u"
            [ ! -f "$file" ] && continue
            flag="${flags[$lang]:-ðŸŒ}"

            echo "" >> "$out_file"
            echo "# ---------------------------" >> "$out_file"
            echo "# â–¶ï¸ $flag $lang Channels" >> "$out_file"
            echo "# ---------------------------" >> "$out_file"

            awk -v lang="$lang" -v flag="$flag" -v start=1 '
              BEGIN { ch=start }
              /^#EXTINF/ {
                info=$0
                if (info !~ /tvg-chno=/) {
                  sub(/^#EXTINF:-1/, sprintf("#EXTINF:-1 tvg-chno=\"%d\"", ch), info)
                }
                print info
                getline url
                print url
                ch++
              }
            ' "$file" >> "$out_file"

            echo "" >> "$out_file"
          done

          echo "âœ… Souloc M3U successfully grouped, flagged, and renumbered."
          echo "ðŸ“º Total channels fetched: $total"
          echo "â™»ï¸ Unique (Updated) channels: $updated"

          {
            echo "## ðŸŒ Souloc Master â€” RJMBTS Auto-Build Summary"
            echo "| Metric | Count |"
            echo "|--------|--------:|"
            echo "| ðŸ“º Total fetched | ${total:-0} |"
            echo "| â™»ï¸ Unique (updated) | ${updated:-0} |"
            echo ""
            echo "### ðŸ“Š Channels by Language"
            echo "| Language | Channels |"
            echo "|-----------|-----------:|"
            tail -n +2 "$tmpdir/lang_stats.csv" | sort -t, -k2 -nr | awk -F, '{printf "| %s | %s |\n", $1, $2}'
            echo ""
            echo "ðŸ•’ **Last updated:** $timestamp"
            echo ""
            echo "ðŸ”¸ **Coded & Maintained by [@RJMBTS](https://github.com/RJMBTS)**"
            echo "ðŸ”¹ **Powered by RJM Tv & Souloc Network**"
          } >> $GITHUB_STEP_SUMMARY
